<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Silent Hour â€“ Novel App</title>
<style>
body { background:#0f1220; color:#eaeaf0; font-family:Inter, Arial, sans-serif; padding:24px; }
.container { max-width:800px; margin:auto; }
.card { background:#171a2f; padding:28px; border-radius:16px; margin-bottom:24px; }
a { color:#6c7cff; text-decoration:none; cursor:pointer; }
h1,h2,h3 { font-family:Georgia; }
input, textarea, select { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #6c7cff; background:#0f1220; color:#eaeaf0; }
button { width:48%; padding:10px; margin:5px 1%; border:none; border-radius:8px; background:#6c7cff; color:white; cursor:pointer; }
button:hover { background:#515aff; }
.hidden { display:none; }
.comment { background:#1e2137; padding:8px; margin:6px 0; border-radius:8px; }
#chapterContent { background:#1e2137; padding:16px; border-radius:12px; margin:16px 0; min-height:120px; white-space: pre-wrap; }
@media(max-width:600px){ button{width:100%; margin:6px 0;} }
</style>
</head>
<body>

<div id="loading" style="position:fixed;inset:0;background:#0f1220;display:flex;align-items:center;justify-content:center;color:#6c7cff;z-index:9999;">Loadingâ€¦</div>

<div class="container">

<h1>ğŸ“– The Silent Hour</h1>
<p>Written by Tieg â€¢ Weekly updates</p>

<!-- LOGIN / SIGNUP -->
<div class="card hidden" id="loginCard">
  <h2>ğŸ”‘ Login / Sign Up</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <input type="password" id="confirmPassword" placeholder="Confirm Password (Sign Up)">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
  <p><a href="#" onclick="forgotPassword()">Forgot Password?</a></p>
</div>

<div class="card hidden" id="logoutCard">
  <button onclick="logout()">Logout</button>
</div>

<div id="content" class="hidden">

<!-- BOOKMARK -->
<div class="card hidden" id="bookmarkCard">
  <h2>â­ Continue Reading</h2>
  <p id="lastReadText"></p>
  <button id="continueBtn">ğŸ‘‰ Continue</button>
</div>

<!-- CHAPTERS -->
<div class="card">
<h2>ğŸ“š Chapters</h2>
<div id="chapterList">Loading chaptersâ€¦</div>
</div>

<!-- CHAPTER CONTENT -->
<div id="chapterContent">Select a chapter to readâ€¦</div>

<!-- COMMENTS -->
<div class="card">
<h3>ğŸ’¬ Comments</h3>
<select id="chapterSelect">
  <option value="">Select a chapter</option>
</select>
<textarea id="commentInput" placeholder="Write a comment..."></textarea>
<button onclick="postComment()">Post Comment</button>
<div id="commentList"></div>
</div>

<!-- ADMIN PANEL -->
<div class="card hidden" id="adminPanel">
<h2>ğŸ›  Admin Panel</h2>
<p>Total Comments: <span id="totalComments">0</span></p>
<button onclick="deleteAllComments()">Delete All Comments</button>
<h3>ğŸ‘¥ Online Users (<span id="onlineCount">0</span>)</h3>
<ul id="onlineUsers"></ul>

<!-- Add New Chapter -->
<h3>â• Add New Chapter</h3>
<input type="text" id="newChapterTitle" placeholder="Chapter Title">
<textarea id="newChapterContent" placeholder="Chapter Content"></textarea>
<label><input type="checkbox" id="newChapterPublished" checked> Published</label>
<button onclick="addChapter()">Add Chapter</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD9PdBAZzQeZbb4z1_vC-Nlc9v46xVMQ6E",
  authDomain: "my-novel-app-ce68b.firebaseapp.com",
  projectId: "my-novel-app-ce68b",
  storageBucket: "my-novel-app-ce68b.appspot.com",
  messagingSenderId: "1040625911547",
  appId: "1:1040625911547:web:0ba4fc967c05664fdd925e",
  measurementId: "G-76F21G6ZT5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
setPersistence(auth, browserLocalPersistence);

const adminEmail = "tiegmicheal@gmail.com";

let chapters = [];
let currentChapterId = null;

// Fallback chapters if Firestore empty
const fallbackChapters = [
  { id: "ch1", title: "When the Clock Stopped", content: "Your chapter text hereâ€¦" },
  { id: "ch2", title: "The Invitation", content: "Your chapter text hereâ€¦" },
  { id: "ch3", title: "The Second That Broke Time", content: "Your chapter text hereâ€¦" }
];

// Track online users
async function updateOnline(user){
  await setDoc(doc(db,"onlineUsers",user.uid),{
    email: user.email,
    lastActive: serverTimestamp()
  });
}

// Auth state
onAuthStateChanged(auth,user=>{
  loading.style.display="none";
  if(user){
    loginCard.classList.add("hidden");
    content.classList.remove("hidden");
    logoutCard.classList.remove("hidden");

    updateOnline(user);

    const panel = document.getElementById("adminPanel");
    if(user.email && user.email.toLowerCase()===adminEmail.toLowerCase()){
      panel.classList.remove("hidden");
      loadOnlineUsers();
    } else {
      panel.classList.add("hidden");
    }

    loadChapters(user);
  } else {
    loginCard.classList.remove("hidden");
    content.classList.add("hidden");
    logoutCard.classList.add("hidden");
  }
});

// Login/Signup/Logout
window.login = () => signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
window.signup = () => {
  if(password.value!==confirmPassword.value){ alert("Passwords do not match"); return; }
  createUserWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
};
window.logout = () => signOut(auth);

// Forgot password
window.forgotPassword = () => {
  if(!email.value){ alert("Enter your email"); return; }
  sendPasswordResetEmail(auth,email.value).then(()=>alert("Reset email sent")).catch(e=>alert(e.message));
};

// Load chapters
async function loadChapters(user){
  chapters = [];
  const chapterListDiv = document.getElementById("chapterList");
  const chapterSelectEl = document.getElementById("chapterSelect");
  chapterListDiv.innerHTML = "";
  chapterSelectEl.innerHTML = '<option value="">Select a chapter</option>';

  const snap = await getDocs(collection(db,"chapters"));
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    if(data.title && data.content && data.published){
      chapters.push({id: docSnap.id, title: data.title, content: data.content});
    }
  });
  if(chapters.length===0) chapters = fallbackChapters;

  chapters.forEach((ch,i)=>{
    const p = document.createElement("p");
    const a = document.createElement("a");
    a.innerText = `Chapter ${i+1}: ${ch.title}`;
    a.onclick = ()=>selectChapter(ch.id,user);
    p.appendChild(a);
    chapterListDiv.appendChild(p);

    const opt = document.createElement("option");
    opt.value = ch.id;
    opt.textContent = `Chapter ${i+1}: ${ch.title}`;
    chapterSelectEl.appendChild(opt);
  });

  // Load last read
  const bmSnap = await getDoc(doc(db,"bookmarks",user.uid));
  const lastId = bmSnap.exists()? bmSnap.data().last : chapters[0].id;
  selectChapter(lastId,user);
}

// Select chapter
async function selectChapter(chId,user){
  const ch = chapters.find(c=>c.id===chId);
  if(!ch) return;
  currentChapterId = chId;

  document.getElementById("chapterContent").innerText = ch.content;

  await setDoc(doc(db,"bookmarks",user.uid),{last:chId});

  document.getElementById("bookmarkCard").classList.remove("hidden");
  document.getElementById("lastReadText").innerText = "Last read: " + ch.title;

  document.getElementById("chapterSelect").value = chId;

  loadComments(chId);
}

// Continue reading button
document.getElementById("continueBtn").onclick = async ()=>{
  const user = auth.currentUser;
  if(user && currentChapterId) selectChapter(currentChapterId,user);
};

// Comments
window.postComment = async ()=>{
  if(!auth.currentUser) return alert("Login first");
  const text = commentInput.value.trim();
  const chapterId = document.getElementById("chapterSelect").value;
  if(!text || !chapterId) return alert("Select a chapter and write a comment");

  const ref = doc(db,"comments",chapterId);
  const snap = await getDoc(ref);
  const list = snap.exists()? snap.data().list:[];
  list.push({ user: auth.currentUser.email, text, time: serverTimestamp() });
  await setDoc(ref,{list},{merge:true});
  commentInput.value="";
  loadComments(chapterId);
};

async function loadComments(chId){
  const commentListEl = document.getElementById("commentList");
  commentListEl.innerHTML="";
  let total=0;
  const snap = await getDoc(doc(db,"comments",chId));
  if(snap.exists() && snap.data().list){
    snap.data().list.forEach(c=>{
      total++;
      const p = document.createElement("p");
      p.className = "comment";
      p.innerHTML = `<b>${c.user}</b>: ${c.text}`;
      commentListEl.appendChild(p);
    });
  }
  document.getElementById("totalComments").innerText = total;
}

// Dropdown change
document.getElementById("chapterSelect").addEventListener("change",e=>{
  const user = auth.currentUser;
  if(user && e.target.value) selectChapter(e.target.value,user);
});

// Admin delete all comments
window.deleteAllComments = async ()=>{
  const user = auth.currentUser;
  if(!user || user.email.toLowerCase()!==adminEmail.toLowerCase()) return alert("Only admin can delete");

  const snap = await getDocs(collection(db,"chapters"));
  snap.forEach(async ch=>{
    await setDoc(doc(db,"comments",ch.id),{list:[]},{merge:true});
  });

  if(currentChapterId) loadComments(currentChapterId);
  alert("All comments deleted");
};

// Admin add new chapter
window.addChapter = async ()=>{
  const title = document.getElementById("newChapterTitle").value.trim();
  const content = document.getElementById("newChapterContent").value.trim();
  const published = document.getElementById("newChapterPublished").checked;

  if(!title || !content) return alert("Title and content are required");

  const newDocRef = doc(collection(db,"chapters"));
  await setDoc(newDocRef,{
    title,
    content,
    published,
    publishedAt: serverTimestamp()
  });

  alert("Chapter added successfully");

  document.getElementById("newChapterTitle").value = "";
  document.getElementById("newChapterContent").value = "";
  document.getElementById("newChapterPublished").checked = true;

  loadChapters(auth.currentUser);
};

// Online users
async function loadOnlineUsers(){
  onlineUsers.innerHTML="";
  const usersSnap = await getDocs(collection(db,"onlineUsers"));
  const now = Date.now();
  let count = 0;
  usersSnap.forEach(u=>{
    const data = u.data();
    if(data.lastActive && data.lastActive.toMillis()>now-600000){ 
      count++;
      const li = document.createElement("li");
      li.innerText = data.email;
      onlineUsers.appendChild(li);
    }
  });
  document.getElementById("onlineCount").innerText = count;
}
</script>

</body>
</html>