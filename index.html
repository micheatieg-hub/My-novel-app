<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Silent Hour â€“ Novel App</title>

<style>
body {
  background:#0f1220;
  color:#eaeaf0;
  font-family:Inter, Arial, sans-serif;
  padding:24px;
}
.container { max-width:800px; margin:auto; }
.card {
  background:#171a2f;
  padding:28px;
  border-radius:16px;
  margin-bottom:24px;
}
a { color:#6c7cff; text-decoration:none; }
h1,h2,h3 { font-family:Georgia; }
input, textarea {
  width:100%;
  padding:10px;
  margin:10px 0;
  border-radius:8px;
  border:1px solid #6c7cff;
  background:#0f1220;
  color:#eaeaf0;
}
textarea { resize: vertical; }
button {
  width:48%;
  padding:10px;
  margin:5px 1%;
  border:none;
  border-radius:8px;
  background:#6c7cff;
  color:white;
  cursor:pointer;
}
button:hover { background:#515aff; }
.message { margin-top:10px; font-size:0.9rem; }
.hidden { display:none; }
.bookmark { color:#ffcc00; font-weight:bold; }
.comment { background:#1e2137; padding:8px; margin:5px 0; border-radius:8px; }
@media(max-width:600px){
  button{width:100%; margin:5px 0;}
}
</style>
</head>

<body>

<!-- ğŸ”„ LOADING SCREEN -->
<div id="loading" style="
  position:fixed;
  inset:0;
  background:#0f1220;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.2rem;
  color:#6c7cff;
  z-index:9999;
">
  Loadingâ€¦
</div>

<div class="container">

<h1>ğŸ“– The Silent Hour</h1>
<p>Written by Tieg â€¢ Weekly updates</p>

<!-- LOGIN / SIGN UP -->
<div class="card hidden" id="loginCard">
  <h2>ğŸ”‘ Login / Sign Up</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <input type="password" id="confirmPassword" placeholder="Confirm Password (Sign Up Only)">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>

  <p>
    <a href="#" onclick="forgotPassword()">Forgot Password?</a>
  </p>

  <div class="message" id="msg"></div>
</div>

<!-- LOGOUT -->
<div class="card hidden" id="logoutCard">
  <button onclick="logout()">Logout</button>
</div>

<!-- CONTENT (LOCKED UNTIL LOGIN) -->
<div id="content" class="hidden">

<div class="card">
<h2>ğŸ“š Chapters</h2>
<p><a href="chapter1.html" id="ch1">Chapter 1: When the Clock Stopped</a></p>
<p><a href="chapter2.html" id="ch2">Chapter 2: The Invitation</a></p>
<p><a href="chapter3.html" id="ch3">Chapter 3: The Second That Broke Time</a></p>
</div>

<!-- COMMENTS PER CHAPTER -->
<div class="card" id="commentsCh1">
  <h3>ğŸ’¬ Comments - Chapter 1</h3>
  <textarea id="commentInputCh1" placeholder="Write a comment..."></textarea>
  <button onclick="submitComment('ch1')">Post Comment</button>
  <div id="commentListCh1"></div>
</div>

<div class="card" id="commentsCh2">
  <h3>ğŸ’¬ Comments - Chapter 2</h3>
  <textarea id="commentInputCh2" placeholder="Write a comment..."></textarea>
  <button onclick="submitComment('ch2')">Post Comment</button>
  <div id="commentListCh2"></div>
</div>

<div class="card" id="commentsCh3">
  <h3>ğŸ’¬ Comments - Chapter 3</h3>
  <textarea id="commentInputCh3" placeholder="Write a comment..."></textarea>
  <button onclick="submitComment('ch3')">Post Comment</button>
  <div id="commentListCh3"></div>
</div>

<div class="card">
<h2>ğŸ”” Notice</h2>
<p>This is an original novel. New chapters are added every week.</p>
</div>

<div class="card">
<h2>â„¹ï¸ App Info</h2>
<p>
<a href="about.html">About</a> â€¢
<a href="privacy.html">Privacy Policy</a> â€¢
<span style="color:#a5a8c6;">Terms â€“ Coming Soon</span>
</p>
</div>

<p style="text-align:center;font-size:0.85rem;">
Â© 2026 The Silent Hour
</p>

</div>
</div>

<!-- ğŸ”¥ FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getAuth,
  setPersistence,
  browserLocalPersistence,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD9PdBAZzQeZbb4z1_vC-Nlc9v46xVMQ6E",
  authDomain: "my-novel-app-ce68b.firebaseapp.com",
  projectId: "my-novel-app-ce68b",
  storageBucket: "my-novel-app-ce68b.appspot.com",
  messagingSenderId: "1040625911547",
  appId: "1:1040625911547:web:0ba4fc967c05664fdd925e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// âœ… KEEP USER LOGGED IN
setPersistence(auth, browserLocalPersistence);

function errorText(code) {
  if (code === "auth/wrong-password") return "Incorrect password.";
  if (code === "auth/user-not-found") return "Account not found.";
  if (code === "auth/invalid-email") return "Invalid email address.";
  if (code === "auth/email-already-in-use") return "Email already registered.";
  if (code === "auth/weak-password") return "Password must be at least 6 characters.";
  return "Login failed.";
}

// ğŸ” AUTH STATE + LOADING FIX
onAuthStateChanged(auth, async user => {
  document.getElementById("loading").style.display = "none";

  if (user) {
    loginCard.classList.add("hidden");
    content.classList.remove("hidden");
    logoutCard.classList.remove("hidden");
    await loadBookmark(user);
    await loadAllComments();
  } else {
    loginCard.classList.remove("hidden");
    content.classList.add("hidden");
    logoutCard.classList.add("hidden");
  }
});

// LOGIN
window.login = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => {
      msg.style.color = "red";
      msg.innerText = errorText(e.code);
    });
};

// SIGN UP
window.signup = () => {
  if (password.value !== confirmPassword.value) {
    msg.style.color = "red";
    msg.innerText = "Passwords do not match.";
    return;
  }

  createUserWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => {
      msg.style.color = "red";
      msg.innerText = errorText(e.code);
    });
};

// LOGOUT
window.logout = () => signOut(auth);

// FORGOT PASSWORD
window.forgotPassword = () => {
  if (!email.value) {
    msg.style.color = "red";
    msg.innerText = "Enter your email first.";
    return;
  }

  sendPasswordResetEmail(auth, email.value)
    .then(() => {
      msg.style.color = "green";
      msg.innerText = "Password reset email sent.";
    })
    .catch(e => {
      msg.style.color = "red";
      msg.innerText = errorText(e.code);
    });
};

// âœ… BOOKMARK FEATURE
function saveBookmark(user, chapterId) {
  const docRef = doc(db, "bookmarks", user.uid);
  setDoc(docRef, { lastChapter: chapterId })
    .then(() => highlightBookmark(chapterId))
    .catch(console.error);
}

async function loadBookmark(user) {
  const docRef = doc(db, "bookmarks", user.uid);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) highlightBookmark(docSnap.data().lastChapter);
}

function highlightBookmark(chapterId) {
  ["ch1","ch2","ch3"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("bookmark");
  });
  const last = document.getElementById(chapterId);
  if(last) last.classList.add("bookmark");
}

["ch1","ch2","ch3"].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener("click", ()=>{
      if(auth.currentUser) saveBookmark(auth.currentUser, id);
    });
  }
});

// âœ… COMMENT FEATURE
async function submitComment(chapterId){
  if(!auth.currentUser) return;
  const input = document.getElementById("commentInput"+chapterId.charAt(0).toUpperCase()+chapterId.slice(1));
  if(!input.value) return;
  const docRef = doc(db, "comments", chapterId);
  const docSnap = await getDoc(docRef);
  let comments = docSnap.exists() ? docSnap.data().list : [];
  comments.push({user: auth.currentUser.email, text: input.value, time: Date.now()});
  await setDoc(docRef, {list: comments});
  input.value = "";
  loadComments(chapterId);
}

async function loadComments(chapterId){
  const docRef = doc(db, "comments", chapterId);
  const docSnap = await getDoc(docRef);
  const listDiv = document.getElementById("commentList"+chapterId.charAt(0).toUpperCase()+chapterId.slice(1));
  listDiv.innerHTML = "";
  if(docSnap.exists()){
    docSnap.data().list.forEach(c=>{
      const p = document.createElement("p");
      p.classList.add("comment");
      const date = new Date(c.time).toLocaleString();
      p.innerHTML = `<b>${c.user}</b> (${date}): ${c.text}`;
      listDiv.appendChild(p);
    });
  }
}

// Load comments for all chapters
async function loadAllComments(){
  ["ch1","ch2","ch3"].forEach(chapterId => loadComments(chapterId));
}
</script>

</body>
</html>