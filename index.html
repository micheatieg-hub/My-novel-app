<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Silent Hour â€“ Novel App</title>
<style>
body { background:#0f1220; color:#eaeaf0; font-family:Inter, Arial, sans-serif; padding:24px; }
.container { max-width:800px; margin:auto; }
.card { background:#171a2f; padding:28px; border-radius:16px; margin-bottom:24px; }
a { color:#6c7cff; text-decoration:none; }
h1,h2,h3 { font-family:Georgia; }
input, textarea, select { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #6c7cff; background:#0f1220; color:#eaeaf0; }
button { width:48%; padding:10px; margin:5px 1%; border:none; border-radius:8px; background:#6c7cff; color:white; cursor:pointer; }
button:hover { background:#515aff; }
.hidden { display:none; }
.comment { background:#1e2137; padding:8px; margin:6px 0; border-radius:8px; }
@media(max-width:600px){ button{width:100%; margin:6px 0;} }
</style>
</head>
<body>

<div id="loading" style="position:fixed;inset:0;background:#0f1220;display:flex;align-items:center;justify-content:center;color:#6c7cff;z-index:9999;">Loadingâ€¦</div>

<div class="container">
<h1>ğŸ“– The Silent Hour</h1>
<p>Written by Tieg â€¢ Weekly updates</p>

<!-- LOGIN / SIGNUP -->
<div class="card hidden" id="loginCard">
  <h2>ğŸ”‘ Login / Sign Up</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <input type="password" id="confirmPassword" placeholder="Confirm Password (Sign Up)">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
  <p><a href="#" onclick="forgotPassword()">Forgot Password?</a></p>
</div>

<div class="card hidden" id="logoutCard">
  <button onclick="logout()">Logout</button>
</div>

<div id="content" class="hidden">

<!-- BOOKMARK -->
<div class="card hidden" id="bookmarkCard">
  <h2>â­ Continue Reading</h2>
  <p id="lastReadText"></p>
  <a id="continueLink" href="#">ğŸ‘‰ Continue</a>
</div>

<!-- CHAPTERS -->
<div class="card">
<h2>ğŸ“š Chapters</h2>
<div id="chaptersList"></div>
</div>

<!-- COMMENTS -->
<div class="card">
<h3>ğŸ’¬ Comments</h3>
<select id="chapterSelect"></select>
<textarea id="commentInput" placeholder="Write a comment..."></textarea>
<button onclick="postComment()">Post Comment</button>
<div id="commentList"></div>
<p>Total Comments: <span id="totalComments">0</span></p>
</div>

<!-- ADMIN PANEL -->
<div class="card hidden" id="adminPanel">
<h2>ğŸ›  Admin Panel</h2>

<h3>â• Add Chapter</h3>
<input type="text" id="newChapterTitle" placeholder="Chapter Title">
<input type="text" id="newChapterLink" placeholder="Chapter HTML Link e.g. chapter4.html">
<button onclick="addChapter()">Add Chapter</button>

<h3>ğŸ—‘ Delete Chapter</h3>
<select id="deleteChapterSelect"></select>
<button onclick="deleteChapter()">Delete Chapter</button>

<h3>ğŸ—‘ Delete All Comments</h3>
<button onclick="deleteAllComments()">Delete All Comments</button>

<h3>ğŸ‘¥ Online Users (<span id="onlineCount">0</span>)</h3>
<ul id="onlineUsers"></ul>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD9PdBAZzQeZbb4z1_vC-Nlc9v46xVMQ6E",
  authDomain: "my-novel-app-ce68b.firebaseapp.com",
  projectId: "my-novel-app-ce68b",
  storageBucket: "my-novel-app-ce68b.appspot.com",
  messagingSenderId: "1040625911547",
  appId: "1:1040625911547:web:0ba4fc967c05664fdd925e",
  measurementId: "G-76F21G6ZT5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
setPersistence(auth, browserLocalPersistence);

const adminEmail = "tiegmicheal@gmail.com";

// Chapters array with published flag
let chapters = JSON.parse(localStorage.getItem('chapters')) || [
  { id:'ch1', title:'Chapter 1: When the Clock Stopped', link:'chapter1.html', published:true },
  { id:'ch2', title:'Chapter 2: The Invitation', link:'chapter2.html', published:true },
  { id:'ch3', title:'Chapter 3: The Second That Broke Time', link:'chapter3.html', published:true }
];

// Auth state
onAuthStateChanged(auth,user=>{
  loading.style.display="none";
  if(user){
    loginCard.classList.add("hidden");
    content.classList.remove("hidden");
    logoutCard.classList.remove("hidden");

    updateOnline(user);

    const panel = document.getElementById("adminPanel");
    if(user.email && user.email.toLowerCase()===adminEmail.toLowerCase()){
      panel.classList.remove("hidden");
      loadOnlineUsers();
    } else panel.classList.add("hidden");

    loadBookmark(user);
    loadComments(chapters[0].id);
  } else {
    loginCard.classList.remove("hidden");
    content.classList.add("hidden");
    logoutCard.classList.add("hidden");
  }
});

// Login/Signup/Logout
window.login = () => signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
window.signup = () => {
  if(password.value!==confirmPassword.value){ alert("Passwords do not match"); return; }
  createUserWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
};
window.logout = () => signOut(auth);
window.forgotPassword = () => {
  if(!email.value){ alert("Enter your email"); return; }
  sendPasswordResetEmail(auth,email.value).then(()=>alert("Reset email sent")).catch(e=>alert(e.message));
};

// --- Online users ---
async function updateOnline(user){
  try{
    await setDoc(doc(db,"onlineUsers",user.uid),{email:user.email,lastActive:serverTimestamp()});
  }catch(e){ console.log('Firebase offline'); }
}

// --- Bookmarks ---
function showBookmark(id){
  bookmarkCard.style.display="block";
  const ch = chapters.find(c=>c.id===id);
  lastReadText.innerText = ch?.title || '';
  continueLink.href = ch?.link || '#';
}

async function loadBookmark(user){
  try{
    const snap = await getDoc(doc(db,"bookmarks",user.uid));
    if(snap.exists()) showBookmark(snap.data().last);
  }catch(e){ console.log('Firebase offline'); }
}

// --- Render Chapters ---
function renderChapters(){
  const list = document.getElementById('chaptersList');
  const select = document.getElementById('chapterSelect');
  const deleteSelect = document.getElementById('deleteChapterSelect');
  list.innerHTML=''; select.innerHTML=''; deleteSelect.innerHTML='';

  chapters.forEach(ch=>{
    if(!ch.published) return;
    // Chapters list
    const a = document.createElement('a');
    a.href=ch.link; a.textContent=ch.title; a.style.display='block';
    list.appendChild(a);

    // Comments select
    const opt = document.createElement('option');
    opt.value=ch.id; opt.textContent=ch.title; select.appendChild(opt);

    // Delete chapter select
    const delOpt = document.createElement('option');
    delOpt.value=ch.id; delOpt.textContent=ch.title; deleteSelect.appendChild(delOpt);
  });

  localStorage.setItem('chapters', JSON.stringify(chapters));
}
renderChapters();

// --- Comments ---
window.postComment = ()=>{
  const user = auth.currentUser;
  if(!user) return alert('Login first');
  const text = commentInput.value.trim();
  const chapterId = chapterSelect.value;
  if(!text) return;

  let list = JSON.parse(localStorage.getItem('comments_'+chapterId)) || [];
  list.push({user:user.email,text,time:Date.now()});
  localStorage.setItem('comments_'+chapterId, JSON.stringify(list));
  commentInput.value='';
  loadComments(chapterId);
};

function loadComments(chapterId){
  commentList.innerHTML='';
  let total=0;
  let list = JSON.parse(localStorage.getItem('comments_'+chapterId)) || [];
  list.forEach(c=>{
    total++;
    const p = document.createElement('p');
    p.className='comment';
    const date = new Date(c.time).toLocaleTimeString();
    p.innerHTML=`<b>${c.user}</b> [${date}]: ${c.text}`;
    commentList.appendChild(p);
  });
  totalComments.innerText = total;
}

// --- Admin ---
window.addChapter = ()=>{
  const title = newChapterTitle.value.trim();
  const link = newChapterLink.value.trim();
  if(!title || !link){ alert('Fill all fields'); return; }
  const id = 'ch'+(chapters.length+1);
  chapters.push({id,title,link,published:true});
  renderChapters();
  newChapterTitle.value=''; newChapterLink.value='';
};

window.deleteChapter = ()=>{
  const id = deleteChapterSelect.value;
  if(!id) return;
  if(!confirm('Delete this chapter?')) return;
  chapters = chapters.map(c=>c.id===id?{...c,published:false}:c);
  localStorage.removeItem('comments_'+id);
  renderChapters();
  loadComments(chapterSelect.value);
  alert('Chapter removed from app');
};

window.deleteAllComments = ()=>{
  if(!confirm('Delete all comments?')) return;
  chapters.forEach(ch=>localStorage.removeItem('comments_'+ch.id));
  loadComments(chapterSelect.value);
  alert('All comments deleted');
};

// --- Online Users ---
async function loadOnlineUsers(){
  const ul = document.getElementById('onlineUsers');
  ul.innerHTML=''; let count=0;
  try{
    const usersSnap = await getDocs(collection(db,'onlineUsers'));
    const now = Date.now();
    usersSnap.forEach(u=>{
      const data = u.data();
      if(data.lastActive && data.lastActive.toMillis()>now-600000){
        count++;
        const li = document.createElement('li');
        const d = new Date(data.lastActive.toMillis());
        li.innerText = (data.email||'Guest') + ` (Last: ${d.toLocaleTimeString()})`;
        ul.appendChild(li);
      }
    });
  }catch(e){ console.log('Firebase offline'); }
  document.getElementById('onlineCount').innerText = count;
}

// --- Chapter select change ---
chapterSelect.addEventListener('change', e=>loadComments(e.target.value));
</script>

</body>
</html>